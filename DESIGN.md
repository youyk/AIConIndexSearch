# AI对话知识库管理插件 - 功能设计文档

## 1. 项目概述

### 1.1 项目名称
AI对话知识库管理插件 (AI Conversation Knowledge Base)

### 1.2 项目目标
开发一个通用的浏览器插件，用于自动捕获、存储和管理与AI（如Gemini、DeepSeek、ChatGPT、Claude等）的对话内容，提供强大的全文搜索功能。帮助用户建立个人知识库，快速检索历史对话内容。

### 1.3 核心价值
- **知识沉淀**：将AI对话转化为可检索的知识库
- **跨时间搜索**：搜索很久以前的对话，不受当前页面限制
- **跨会话搜索**：搜索不同时间、不同会话的对话
- **提高效率**：避免重复提问，快速找到历史答案
- **知识管理**：通过标签、分类、笔记等方式管理知识
- **数据导出**：支持多种格式导出，便于备份和分享

---

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 域名配置管理
**功能描述**：允许用户配置需要跟踪的AI平台域名

**功能点**：
- 在插件设置页面中配置域名列表
- 支持添加/删除域名
- 预设常见AI平台（Gemini、ChatGPT、DeepSeek、Claude等）
- 支持自定义域名
- 每个域名可单独启用/禁用
- 配置存储在本地（chrome.storage.local）

**配置项**：
- 域名（如：gemini.google.com）
- 启用状态（boolean）
- 显示名称（可选）

#### 2.1.2 自动内容捕获
**功能描述**：自动监听并捕获AI对话内容

**激活条件**：
- 当前访问的域名在配置列表中
- 域名配置为启用状态

**捕获机制**：
- 实时监听页面DOM变化（MutationObserver）
- 智能观察范围：优先观察对话容器，减少不必要的监听
- 变化过滤：只处理与对话相关的DOM变化
- 节流和防抖：限制处理频率，避免过度消耗CPU
- 页面可见性检测：页面隐藏时暂停观察，节省资源
- 并发控制：防止重复处理
- 识别对话结构（用户问题 + AI回答）
- 处理流式输出（等待内容完整后再捕获）
- 避免重复捕获（通过唯一ID识别，基于内容哈希）

**捕获内容**：
- 时间戳
- 用户问题（纯文本和HTML格式）
- AI回答（纯文本和HTML格式，保留原始格式）
- 对话标题（从页面提取）
- 平台标识
- 域名信息
- 页面URL（可选）

**平台支持**：
- Gemini (gemini.google.com)
- DeepSeek (chat.deepseek.com)
- ChatGPT (chat.openai.com)
- Claude (claude.ai)
- 其他平台（可扩展）

#### 2.1.3 数据存储
**功能描述**：持久化存储对话内容

**存储方式**：
- IndexedDB：存储对话数据和索引
- chrome.storage.local：存储配置和域名列表

**存储内容**：
- 对话ID（唯一标识）
- 时间戳
- AI平台名称
- 域名
- 用户问题
- AI回答
- 格式化的HTML内容（保留原始格式，用于导出和显示）
- 对话标题（从页面提取）
- 元数据（标签、分类、笔记、收藏状态等）

**存储限制**：
- **最大存储空间**：100MB（可配置）
- **警告机制**：
  - 80%使用率：显示橙色警告，建议定期清理
  - 95%使用率：显示红色严重警告，建议立即清理
  - 100%使用率：阻止保存新对话，必须清理数据后才能继续保存

**存储监控**：
- 实时监控存储使用情况
- 在设置页面显示：
  - 当前存储大小
  - 最大存储限制
  - 使用率百分比
  - 存储位置信息
- 保存新对话时自动检查存储限制
- 达到上限时显示明确的错误提示

**数据管理**：
- 支持数据导出/导入
- 支持数据清理和归档
- 支持按条件删除
- 存储使用情况可视化显示

#### 2.1.4 全文搜索
**功能描述**：提供强大的全文搜索功能

**搜索能力**：
- 全文搜索：在问题和答案中搜索关键词
- 模糊匹配：支持拼写容错
- 多关键词搜索：支持多个关键词组合
- 实时搜索：输入即搜索，无需点击按钮

**筛选功能**：
- 时间范围筛选：按日期筛选对话
- 平台筛选：按AI平台筛选
- 标签筛选：按标签筛选
- 收藏筛选：只显示收藏的对话

**排序功能**：
- 按相关性排序（默认）
- 按时间排序（最新/最旧）

**搜索界面**：
- 浏览器插件弹窗（Popup）
- 搜索输入框（自动聚焦）
- 筛选面板（可折叠）
- 搜索结果列表
- 结果高亮显示
- 显示匹配片段和上下文

#### 2.1.5 内容管理
**功能描述**：管理已存储的对话内容

**查看功能**：
- 查看对话详情（完整问题和回答）
- 显示对话元数据（时间、平台、标签等）

**编辑功能**：
- 添加/删除标签
- 设置分类
- 添加个人笔记
- 收藏/取消收藏对话

**删除功能**：
- 删除单条对话
- 批量删除对话
- 按条件删除（时间范围、平台等）

**批量操作**：
- 批量添加标签
- 批量删除
- 批量导出

#### 2.1.6 数据导出
**功能描述**：将对话数据导出为多种格式

**支持格式**：
- **JSON**：结构化数据，便于程序处理
- **Markdown**：便于阅读和编辑，支持Markdown语法
- **HTML**：美观的网页格式，包含完整样式，便于分享和查看
- **CSV**：表格格式，便于数据分析
- **PDF**：便携式文档格式，便于打印和分享，保留完整格式和样式

**导出选项**：
- 导出全部对话
- 导出选中的对话
- 按筛选条件导出（时间范围、平台、标签等）

**导出内容**：
- 对话的完整内容（问题和回答）
- 格式化的HTML内容（如果存在，保留原始格式）
- 元数据（时间、平台、标签、笔记等）
- 格式化的时间显示
- 标签和分类信息
- 对话标题（如果存在）

**HTML导出特性**：
- 美观的页面布局
- 响应式设计（支持移动端查看）
- 打印友好样式
- 对话编号和时间戳
- 标签和笔记的视觉区分
- 收藏标记显示
- 保留原始格式（代码块、列表、表格等）

**PDF导出特性**：
- 保留完整的格式和样式
- 支持代码块、列表、表格等复杂格式
- 自动分页，避免内容截断
- 优化的打印布局
- 包含导出时间和对话统计信息

### 2.2 扩展功能

#### 2.2.1 数据统计
- 对话总数统计
- 按平台统计对话数量
- 按时间统计（日/周/月）
- 标签使用统计
- **存储空间使用情况**：
  - 当前存储大小（格式化显示：B/KB/MB/GB）
  - 最大存储限制（默认100MB）
  - 使用率百分比
  - 存储位置信息（操作系统和路径说明）
  - **存储警告**：
    - 当使用率达到80%时，显示橙色警告提示
    - 当使用率达到95%时，显示红色严重警告提示
    - 警告信息包含具体的使用情况和清理建议

#### 2.2.2 搜索增强
- 搜索历史记录
- 搜索建议（基于历史搜索）
- 相关对话推荐
- 高级搜索（正则表达式、布尔运算符）

#### 2.2.3 界面增强
- 暗色模式
- 自定义样式
- 快捷键支持
- 多语言支持（可选）

---

## 3. 技术架构

### 3.1 技术选型

#### 3.1.1 前端技术
- **插件框架**：Chrome Extension Manifest V3
- **UI框架**：React + TypeScript（推荐）或原生HTML/CSS/JS
- **状态管理**：React Context / Zustand（如使用React）
- **样式方案**：Tailwind CSS 或 CSS Modules

#### 3.1.2 索引与搜索
- **全文搜索引擎**：FlexSearch（轻量、快速、支持中英文）
- **搜索配置**：支持中英文分词、模糊匹配、相关性排序

#### 3.1.3 数据存储
- **本地存储**：
  - IndexedDB：存储对话数据和索引
  - chrome.storage.local：存储配置和域名列表

#### 3.1.4 内容捕获
- **DOM监听**：使用 MutationObserver 监听页面变化
- **内容提取**：针对不同平台编写适配器

### 3.2 系统架构

**模块划分**：
1. **Content Script**：内容捕获模块
2. **Background Script**：数据处理和索引管理模块
3. **Popup UI**：用户界面模块
4. **Storage**：数据持久化模块

**数据流**：
1. Content Script 捕获对话 → 发送到 Background Script
2. Background Script 处理数据 → 存储到 IndexedDB → 建立索引
3. Popup UI 发送搜索请求 → Background Script 执行搜索 → 返回结果
4. Popup UI 发送导出请求 → Background Script 生成导出文件 → 下载

### 3.3 数据模型

**对话数据结构**：
- id: 唯一标识符（基于内容哈希，确保相同对话生成相同ID）
- timestamp: 时间戳
- platform: AI平台名称
- domain: 域名
- question: 用户问题（纯文本，用于搜索）
- answer: AI回答（纯文本，用于搜索）
- questionHtml: 用户问题的HTML格式（可选，保留原始格式）
- answerHtml: AI回答的HTML格式（可选，保留原始格式）
- title: 对话标题（可选，从页面提取）
- tags: 标签数组（可选）
- category: 分类（可选）
- notes: 个人笔记（可选）
- favorite: 是否收藏（可选）
- sessionId: 会话ID（可选）
- pageUrl: 页面URL（可选）

**搜索选项**：
- query: 搜索关键词
- limit: 结果数量限制
- platform: 平台筛选
- tags: 标签筛选
- startDate: 开始时间
- endDate: 结束时间
- sortBy: 排序方式（相关性/时间）

**导出选项**：
- format: 导出格式（json/markdown/html/csv）
- conversationIds: 选中的对话ID（可选）
- filters: 筛选条件（可选）

---

## 4. 用户界面设计

### 4.1 Popup界面布局

**主界面**：
- 顶部：搜索输入框（自动聚焦）
- 中部：筛选面板（可折叠）
  - 平台选择器
  - 时间范围选择器
  - 标签选择器
  - 收藏筛选开关
- 底部：搜索结果列表
  - 对话卡片（问题预览、回答预览、时间、平台、标签）
  - 点击查看详情
  - 操作按钮（收藏、标签、笔记、删除）

**对话详情界面**：
- 完整问题和回答显示
- 元数据展示（时间、平台、标签等）
- 编辑功能（标签、笔记、分类）
- 操作按钮（收藏、删除、导出）

**设置界面**：
- 域名配置管理
- 导出/导入功能
- **数据统计**：
  - 对话总数
  - 存储大小（当前/最大/使用率）
  - 存储位置信息
  - 平台分布统计
  - 时间范围（最早/最新记录）
  - **存储警告**（如果使用率超过阈值）
- 其他设置选项

### 4.2 交互流程

**搜索流程**：
1. 用户打开插件（点击图标）
2. 自动聚焦搜索框
3. 输入关键词，实时显示结果
4. 使用筛选器缩小范围
5. 点击结果查看详情
6. 可进行收藏、添加标签、笔记等操作

**内容捕获流程**：
1. 用户在配置的AI平台进行对话
2. 插件自动检测并捕获（后台进行）
3. 捕获成功后显示通知（可选，可在设置中关闭）
4. 内容自动索引，立即可搜索

**导出流程**：
1. 在搜索结果页面或设置页面点击"导出"
2. 选择导出格式（HTML/Markdown/JSON/CSV）
3. 选择导出范围（全部/选中/筛选结果）
4. 点击导出，自动下载文件

---

## 5. 开发计划

### 5.1 MVP版本（第一阶段）
**目标**：实现核心功能

**功能清单**：
- 基础插件框架搭建
- 域名配置管理功能
- 支持1-2个主流平台的内容捕获（如ChatGPT、Gemini）
- 基础索引功能（FlexSearch）
- Popup搜索界面
- 数据存储（IndexedDB）
- 结果展示和详情查看
- 基础导出功能（JSON、Markdown）

**预计时间**：3-4周

### 5.2 增强版本（第二阶段）
**目标**：完善功能和用户体验

**功能清单**：
- 支持更多AI平台（DeepSeek、Claude等）
- 搜索功能增强（筛选、排序）
- 标签和分类功能
- 收藏和笔记功能
- HTML和CSV导出功能
- 批量操作功能

**预计时间**：2-3周

### 5.3 优化版本（第三阶段）
**目标**：性能优化和高级功能

**功能清单**：
- 搜索性能优化
- 数据统计功能
- 暗色模式
- 快捷键支持
- 数据导入功能
- 相关对话推荐

**预计时间**：1-2周

---

## 6. 技术难点与解决方案

### 6.1 内容捕获的准确性
**难点**：不同AI平台的DOM结构不同，且可能频繁变化

**解决方案**：
- 使用多种选择器策略（class、data属性、结构特征）
- 定期更新适配器
- 提供用户反馈机制
- 支持手动添加对话（作为备选）

### 6.2 流式输出的处理
**难点**：AI回答可能是流式输出，需要等待完整内容

**解决方案**：
- 监听DOM的连续变化
- 使用防抖机制，等待一段时间无变化后再提取
- 标记"进行中"状态，后续更新完整内容

### 6.3 搜索性能
**难点**：随着数据量增长，搜索可能变慢

**解决方案**：
- 使用高效的索引库（FlexSearch）
- 限制搜索结果数量
- 分页加载
- 异步搜索，不阻塞UI

### 6.4 数据量增长
**难点**：随着对话增多，存储空间会增长

**解决方案**：
- **存储限制**：设置100MB的存储上限，防止无限增长
- **存储监控**：实时监控存储使用情况，及时提醒用户
- **告警机制**：
  - 80%使用率时显示警告，提醒用户清理
  - 95%使用率时显示严重警告，建议立即清理
  - 100%使用率时阻止保存，强制用户清理
- 定期清理旧数据（可配置保留时间）
- 数据压缩（可选）
- 提供数据导出和归档功能
- 支持选择性删除
- 在设置页面显示详细的存储使用情况和建议

### 6.5 性能优化
**难点**：插件运行不应影响页面性能和用户体验

**解决方案**：
- **减少控制台输出**：移除所有非关键的console输出，只保留关键错误处理
- **智能DOM观察**：
  - 优先观察对话容器而非整个页面
  - 过滤无关的DOM变化
  - 使用节流和防抖机制
- **页面可见性检测**：页面隐藏时暂停观察，节省CPU资源
- **并发控制**：防止重复处理和资源竞争
- **批量处理**：批量查询和保存，减少数据库操作
- **异步处理**：所有耗时操作异步执行，不阻塞主线程

---

## 7. 用户体验设计

### 7.1 设计原则
- **简洁明了**：界面简洁，突出搜索功能
- **快速响应**：实时搜索，快速反馈
- **信息清晰**：结果展示清晰，易于阅读
- **操作便捷**：常用功能一键可达

### 7.2 快捷键设计
- `Ctrl+Shift+K` (Mac: `Cmd+Shift+K`)：打开搜索界面（在popup中）
- `Esc`：关闭对话框
- `Enter`：打开第一个搜索结果
- `↑↓`：在结果列表中导航

### 7.3 视觉设计
- 现代化的UI设计
- 清晰的层次结构
- 合适的颜色对比度
- 响应式布局（适配不同屏幕）

---

## 8. 隐私与安全

### 8.1 数据隐私
- **本地存储**：所有数据存储在用户本地，不上传到服务器
- **用户控制**：用户可以随时查看、删除数据
- **权限最小化**：只请求必要的浏览器权限

### 8.2 安全考虑
- **内容安全**：不收集用户隐私信息
- **数据导出**：支持导出备份，用户可自行管理
- **权限说明**：清晰说明插件需要的权限及原因

---

## 9. 测试计划

### 9.1 功能测试
- 内容捕获准确性测试（各平台）
- 搜索功能测试（各种查询场景）
- 数据存储和检索测试
- UI交互测试
- 标签和分类功能测试
- 导出功能测试（各种格式）

### 9.2 性能测试
- 大量数据下的搜索性能（1000+ 对话）
- 索引建立速度
- 内存占用测试
- 页面加载速度
- 导出大文件性能

### 9.3 兼容性测试
- 不同浏览器测试（Chrome、Edge、Firefox等）
- 不同平台版本测试
- 不同操作系统测试

---

## 10. 未来扩展方向

### 10.1 功能扩展
- **云端同步**：可选的数据云端同步（用户授权）
- **多设备支持**：跨设备访问对话历史
- **AI增强**：使用AI总结和分类对话
- **协作功能**：分享知识库（可选）

### 10.2 平台扩展
- 支持更多AI平台
- 支持API方式捕获（如果平台提供API）

### 10.3 搜索增强
- **语义搜索**：使用embedding进行语义搜索
- **智能推荐**：推荐相关对话
- **搜索历史**：记录搜索历史

---

## 11. 总结

本设计文档详细规划了AI对话知识库管理插件的功能需求。项目采用浏览器插件形式，通过自动捕获、智能索引和全文搜索，帮助用户高效管理和检索AI对话内容。

核心功能包括：
1. **域名配置管理**：配置需要跟踪的AI平台
2. **自动内容捕获**：自动识别和捕获AI对话，保留原始格式
3. **数据存储**：持久化存储对话内容，带存储限制和监控
4. **全文搜索**：强大的搜索功能，支持关键词、筛选、排序
5. **内容管理**：标签、分类、笔记、收藏等管理功能
6. **数据导出**：支持JSON、Markdown、HTML、CSV、PDF多种格式导出
7. **存储管理**：存储使用情况监控、告警机制、数据统计
8. **性能优化**：智能DOM观察、节流防抖、页面可见性检测，减少对页面性能的影响

这是一个通用的知识库管理工具，适用于任何使用AI对话的场景，帮助用户建立个人知识库，提高学习和工作效率。
